version: '3.7'

services:
  db:
    image: conceptant/hapi-fhir
    ports:
      - "8080:8080"
  cql-exec:
  # https://github.com/DBCG/cql_execution_service
  # build: https://github.com/DBCG/cql_execution_service.git
    build:
      context: cql-exec
    ports:
      - "8081:8080" # still need to verify this
  cql-runner:
  # https://github.com/DBCG/cql_runner
    build:
      context: cql-runner
    ports:
      - "8082:4200"
    volumes:
      - ./cql-runner/environments:/cql_runner/src/environments
  synthea:
  # https://github.com/synthetichealth/synthea
  # https://synthetichealth.github.io/module-builder
    build:
      context: synthea
    environment:
      SYNTHEA_P: 2
      FHIR_SERVER_URL: http://db:8080/baseDstu3/
      WAIT_HOSTS: http://db:8080/baseDstu3/
      WAIT_TIMEOUT: 90
      WAIT_SLEEP_INTERVAL: 5
    volumes:
      - ./synthea/modules/:/synthea/src/main/resources/modules/
      - ./synthea/output/:/synthea/output/
  # TODO: create a graph
#  bootstrap:
  # TODO: